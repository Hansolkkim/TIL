# CS10 | HTTP Client

## JK ê°•ì˜

* ë„¤íŠ¸ì›Œí¬ ìš©ì–´ë“¤ì— ê´€í•œ ê°ì„ ë¹¨ë¦¬ ì¡ëŠ” ê²ƒì´ ì¤‘ìš”í•¨

* HTTP í”„ë¡œí† ì½œì´ ë§ì´ ì‚¬ìš©ë˜ê³  ìˆëŠ”ë°, ë‹¤ë¥¸ í”„ë¡œí† ì½œ ëŒ€ë¹„ ê°„ë‹¨í•œ í¸ì´ë¼ê³ ..

* URL ë§í¬ë¥¼ ëˆŒë €ì„ ë•Œ ì›¹ ë¸Œë¼ìš°ì €ì— ì–´ë–¤ ì¼ì´ ì¼ì–´ë‚˜ëŠ”ì§€ë¥¼ ë”°ë¼ê°€ë³´ìëŠ” ê²ƒì´ ì´ë²ˆ ê³¼ì œì˜ ëª©í‘œ

	URL ì…ë ¥ -> DNS Requestë¥¼ ì „ì†¡/ DNSë¡œ ì„œë²„ ì£¼ì†Œë¥¼ ì•Œì•„ë´ë¼ -> ì„œë²„ ì£¼ì†Œë¡œ Socketì„ ì—°ê²° -> Requestë¥¼ ë§Œë“¤ì–´ì„œ ì „ì†¡ -> Responseê°€ ì˜¤ë©´ Responseë¥¼ ëª¨ì•„ë³´ê³ ...



## ìƒí™œì½”ë”© HTTP

### OT

ì›¹ì´ ì²˜ìŒ ì†Œê°œ ëì„ ë•Œ, ì›¹ì€ í¬ê²Œ 4ê°€ì§€ ìš”ì†Œë¡œ ì´ë£¨ì–´ì ¸ ìˆì—ˆìŒ

1. HTML : ì›¹ í˜ì´ì§€ë¥¼ ë§Œë“œëŠ” ì»´í“¨í„° ì–¸ì–´
2. URL, URI : ì›í•˜ëŠ” ì›¹ í˜ì´ì§€ì— ë°©ë¬¸í•˜ë„ë¡ ë„ì™€ì£¼ëŠ” ì£¼ì†Œ ì²´ê³„
3. Web Browser, Web Server : ì›¹ í˜ì´ì§€ë¥¼ ì£¼ê³  ë°›ëŠ” ì†Œí”„íŠ¸ì›¨ì–´
4. HTTP : Web Browser, Web Serverê°€ í†µì‹ í•  ë•Œ ì‚¬ìš©í•˜ëŠ” í†µì‹  ê·œì¹™



### ì†Œê°œ

HTTP : HyperText Transfer Protocol

<img src="/Users/hansolkim/Library/Application Support/CleanShot/media/media_bWBjLJlZCf/SS 2022-02-10 AM 11.23.47.jpg" width="70%;" />

HTTPëŠ” Requestì™€ Responseë¡œ ì´ë£¨ì–´ì ¸ ìˆìŒ. (ì„œë¡œ ì•Œì•„ë“¤ì„ ìˆ˜ ìˆë„ë¡ ê³µí†µì ìœ¼ë¡œ ì•½ì†í•œ ë©”ì‹œì§€)



<img src="https://user-images.githubusercontent.com/92504186/153455362-de3806cd-aa7b-4ad4-b1ef-991388d5c9b8.jpg" alt="SS 2022-02-10" width="80%;" />

ì›¹ ë¸Œë¼ìš°ì € : ì‚¬ìš©ìê°€ ìš”ì²­í•œ ì •ë³´ë¥¼ Text ì •ë³´(Header)ë¡œ ë§Œë“¤ì–´ì„œ ì›¹ ì„œë²„ì— ëŒ€ì‹  ìš”ì²­í•´ì£¼ëŠ” ê¸°ê³„/ ì‘ë‹µë°›ì€ ì •ë³´ë¥¼ í™”ë©´ì— ê·¸ë ¤ì£¼ëŠ” ê¸°ê³„

ì›¹ ì„œë²„ : ìê¸°ê°€ ê°–ê³  ìˆëŠ” ì •ë³´ë¥¼ Response Header í˜•íƒœë¡œ ë§Œë“¤ì–´ì„œ ì‘ë‹µí•˜ëŠ” ê¸°ê³„



### Request Message

<img src="https://user-images.githubusercontent.com/92504186/153456185-6e49642a-74a0-437d-8323-b99a2ab6e3b3.jpg" width="70%;" />

1. `GET` : ë°ì´í„°ë¥¼ ì›¹ ì„œë²„ë¡œë¶€í„° ê°€ì ¸ì˜¬ ë•Œ ì‚¬ìš©í•˜ëŠ” ë©”ì„œë“œ
2. `/doc/test.html` : ì›¹ ì„œë²„í•œí…Œ ìš”ì²­í•˜ëŠ” ì •ë³´ê°€ ë¬´ì—‡ì¸ì§€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ë‚´ìš©
3. `HTTP/1.1` : ì›¹ ë¸Œë¼ìš°ì €ê°€ ì‚¬ìš©í•˜ëŠ” HTTPë²„ì „
4. `Host: www.test101.com` : í•´ë‹¹ ì›¹ ì„œë²„ì˜ ì£¼ì†Œ ex) `localhost:8080`ì—ì„œ 8080ì€ í•´ë‹¹ ì›¹ ì„œë²„ê°€ ì—°ê²°ë¼ìˆëŠ” Port
5. `User-Agent: ..` : ì›¹ ë¸Œë¼ìš°ì €ì˜ ë‹¤ë¥¸ í‘œí˜„



### Response Message

<img src="https://user-images.githubusercontent.com/92504186/153457165-5d3d5c0a-4cf5-4398-adb4-6e8826f71f57.jpg" alt="SS 2022-02-10-2" width="60%;" />

<img src="https://user-images.githubusercontent.com/92504186/153457185-95b55732-55c8-451b-b056-e04d54c43982.jpg" alt="SS 2022-02-10-3" width="60%;" />



## ğŸ’¬í•™ìŠµ í‚¤ì›Œë“œ

`HTTP` `Request` `Response`

## ğŸ“Œì²´í¬ ë¦¬ìŠ¤íŠ¸

- [x] í…ìŠ¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ HTTPë¥¼ ë³´ë‚´ê³  ì²˜ë¦¬í•˜ëŠ” ì›¹ ë¸Œë¼ìš°ì €ë¥¼ ë§Œë“¤ê¸°

- [x] ì›¹ ë¸Œë¼ìš°ì €ê°€ ìš”ì²­ì„ ë³´ë‚´ëŠ” ë™ì‘ì„ ê·¸ëŒ€ë¡œ êµ¬í˜„í•˜ê¸°

	- [x] HTTP Request ê·œê²©ì„ ì²˜ë¦¬í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª¨ë“ˆ ë˜ëŠ” í´ë˜ìŠ¤ë¥¼ êµ¬í˜„í•œë‹¤.
		- [x] ê¸°ì¡´ì— ì œê³µí•˜ëŠ” HTTP Request ëª¨ë“ˆì´ë‚˜ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë©´ ì•ˆëœë‹¤.(URL ê°ì²´ëŠ” ì‚¬ìš© ê°€ëŠ¥)
	- [x] ë§¤ê°œë³€ìˆ˜ë¡œ URLì„ ë„˜ê²¨ì„œ Request ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
	- [x] ìš”ì²­ ë°©ì‹ì„ ë³€ê²½í•˜ê¸° ìœ„í•´ methodë¥¼ ë°”ê¿€ ìˆ˜ ìˆë‹¤. ê¸°ë³¸ê°’ì€ `GET` ë©”ì†Œë“œë¡œ ìƒì„±í•œë‹¤.
	- [x] ì „ì†¡í•˜ê¸° ìœ„í•´ Request Messageë¥¼ ë¬¸ìì—´ë¡œ returní•˜ëŠ” ë©”ì†Œë“œë¥¼ êµ¬í˜„í•œë‹¤.

- [x] í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•  ë•Œ URLì„ ì…ë ¥í•œë‹¤.

- [x] ì…ë ¥ëœ URL êµ¬ì„± ìš”ì†Œë¥¼ ë¶„ì„í•´, URLì— í¬í•¨ëœ host ì£¼ì†Œë¥¼ DNS Serverì—ì„œ ê²€ìƒ‰í•œë‹¤.

	- [x] ìŠ¤ìœ„í”„íŠ¸ëŠ” ë³„ë„ DNS ì¡°íšŒì—†ì´ NWEndPointë¥¼ í™œìš©í•´ì„œ ê·¸ëŒ€ë¡œ Socketì— ì—°ê²°í•œë‹¤.[(ì°¸ê³ ìë£Œ)](https://developer.apple.com/documentation/network/2976720-nw_endpoint_create_host)

- [x] host ì •ë³´ë¡œ ì°¾ì€ IP ì£¼ì†Œ ì¤‘ ì²« ë²ˆì§¸ ê°’ê³¼ port ì •ë³´ë¡œ TCP Socketì„ ì—°ê²°í•œë‹¤.(portê°€ ì—†ìœ¼ë©´ 80ë²ˆì„ ì§€ì •í•œë‹¤.)

	ìŠ¤ìœ„í”„íŠ¸ëŠ” `Network.framework` ë¥¼ ì´ìš©í•œë‹¤.

- [x] URL ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ HTTP Request ê°ì²´ë¥¼ ìƒì„±í•˜ê³ , Request ë©”ì‹œì§€ë¥¼ TCP ì„¸ì…˜ì— ì „ì†¡(send)í•œë‹¤. ì†Œì¼“ì„ ìƒì„±í•´ì„œ ìš”ì²­ì„ ë³´ë‚´ê³  ì‘ë‹µì„ ë°›ì•„ì„œ ì²˜ë¦¬í•˜ëŠ” ë™ì‘ì„ êµ¬í˜„í•œë‹¤.

- [x] ì‘ë‹µ ë°ì´í„°(Response Message)ë¥¼ ë¶„ì„í•˜ê¸° ìœ„í•œ HTTPResponse ê°ì²´ êµ¬í˜„

	- [x] Header ë¶€ë¶„ê³¼ Body ë¶€ë¶„ì„ ë¶„ë¦¬
	- [x] HTTP Response Status ì½”ë“œë¥¼ ë¶„ë¦¬
	- [x] HTTP Headerì—ì„œ Content-Lengthê°’ ë¶„ë¦¬
	- [ ] statusCode: Int / responseLine: String / contentLength: Int / headers: [String] / body: Buffer í”„ë¡œí¼í‹°ë¡œ êµ¬ì„±ë˜ë„ë¡ í•¨.

- [x] Response Headerë¥¼ ë¬¸ìì—´ë¡œ ì¶œë ¥í•˜ê³ , Bodyë¥¼ ë¬¸ìì—´ë¡œ ë°”ê¿”ì„œ ì¶œë ¥í•œë‹¤.

- [x] ëª¨ë“  ë°ì´í„°ë¥¼ ë°›ê³  3ì´ˆ í›„ì— socketì„ ì†Œë©¸í•˜ê³  í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•œë‹¤.

---

## ğŸ’»ì§„í–‰ê³¼ì •

1. HTTP Request ê·œê²©ì„ ì²˜ë¦¬í•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤. í•´ë‹¹ í´ë˜ìŠ¤ì—ì„œëŠ” ì‚¬ìš©ìì˜ ì…ë ¥(ë¬¸ìì—´)ì„ `init` ë©”ì„œë“œì˜ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì•„ì™€, í•´ë‹¹ ë¬¸ìì—´ì„ URLíƒ€ì…ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ í”„ë¡œí¼í‹°ë¡œ ì·¨í•˜ê³ , ë³€í™˜ëœ URL í”„ë¡œí¼í‹°ì—ì„œ hostê°’ì„ ì¶”ì¶œí•˜ì—¬ `NWEndpoint.Host`íƒ€ì…ì¸ host í”„ë¡œí¼í‹°ë¥¼ ì·¨í•©ë‹ˆë‹¤. ë˜í•œ URL, host í”„ë¡œí¼í‹°ë¥¼ ì´ìš©í•´  `NWConnection`íƒ€ì…ì¸ connection í”„ë¡œí¼í‹°ê°’ì„ ì´ˆê¸°í™”í•´ì¤ë‹ˆë‹¤. í•´ë‹¹ í´ë˜ìŠ¤ì˜ ì´ˆê¸°í™” ë©”ì„œë“œëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

	```swift
	//class Request
	/*í”„ë¡œí¼í‹° ëª©ë¡
	var url: URL
	var host: NWEndpoint.Host
	var connection: NWConnection */
	
	init(url: String) {
	    self.url = URL(string: url)!
	    self.host = .init(self.url.host!)
	    let port: NWEndpoint.Port = url.components(separatedBy: ":").first! == "https" ? .https : .http
	    self.connection = .init(host: host, port: port, using: .tcp)
	
		self.connect()
	}
	```

	ë˜í•œ ì´ˆê¸°í™” ë©”ì„œë“œ ë‚´ì—ì„œ ì´ˆê¸°í™”ëœ hostì™€ ì…ë ¥ëœ urlì— "https"ê°€ í¬í•¨ë˜ì–´ìˆëŠ”ì§€ ì—¬ë¶€ì— ë”°ë¼ ì§€ì •í•œ port ê°’ì„ ì´ìš©í•´ TCP Socketì— ì—°ê²°í•©ë‹ˆë‹¤. í•´ë‹¹ ë©”ì„œë“œ ë‚´ì˜ `connect()` ë©”ì„œë“œëŠ” ì•„ë˜ì™€ ê°™ì´ ì„ ì–¸í–ˆìŠµë‹ˆë‹¤.

	```swift
	//class Request
	func connect() {
	    self.connection.stateUpdateHandler = { state in
	        print("\nState Update: \(state)\n")
	        switch state {
	        case .ready:
	            let ip = self.connection.currentPath?.remoteEndpoint?.debugDescription.replacingOccurrences(of: ":", with: " ")
	            print("TCP Connection: \(ip!)\n")
	        case .setup:
	            //The connection has been initialized but not started
	            print("Setup")
	        case .cancelled:
	            //The connection has been calcelled
	            print("Cancelled")
	        case .preparing:
	            //The connection in the process of being established
	            print("Preparing")
	        default:
	            print("Waiting or Failed")
	        }
	    }
	    self.connection.start(queue: DispatchQueue.global())
	}
	```

	í•´ë‹¹ ë©”ì„œë“œì—ì„œëŠ” HTTPRequest í´ë˜ìŠ¤ì˜ connection í”„ë¡œí¼í‹°ë¥¼ ì´ìš©í•´ TCP Socketì— ì—°ê²°ì„ ì§„í–‰í•©ë‹ˆë‹¤. connectionì˜ stateì— ë”°ë¼ ê°ê° stateë¥¼ ì¶œë ¥í•´ì£¼ë„ë¡ í–ˆëŠ”ë°, ready stateê°€ ëœë‹¤ë©´ í•´ë‹¹ TCP Connection IPë¥¼ ì¶œë ¥í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤. ready stateì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì´ ì¶œë ¥ë©ë‹ˆë‹¤.

	<img src="https://user-images.githubusercontent.com/92504186/153436087-22eb9c37-b092-4035-99a2-be5554038d18.jpg" alt="SS 2022-02-11 AM 12 08 30" width="40%;" />

	

2. ìœ„ì—ì„œ ì—°ê²°í•œ TCP ì„¸ì…˜ì— Request Messageë¥¼ ì „ì†¡í•  `sendRequest(method: String)` ë©”ì„œë“œë¥¼ ì •ì˜í–ˆìŠµë‹ˆë‹¤. í•´ë‹¹ ë©”ì„œë“œì˜ ë§¤ê°œë³€ìˆ˜ë¡œ ì‚¬ìš©ë˜ëŠ” `method` ê°’ì€ main.swiftì—ì„œ Input êµ¬ì¡°ì²´ë¥¼ ì´ìš©í•´ ì‚¬ìš©ìì˜ ì…ë ¥ì„ ë°›ì•„ì™€, GET, HEAD, PUT, POST, PATCH, TRACE, OPTIONS, DELETE ì¤‘ì˜ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ë„ë¡ í–ˆìœ¼ë©°, ì¼ì¹˜í•˜ëŠ” methodê°€ ì—†ì„ ê²½ìš°ì—ëŠ” GET ë©”ì†Œë“œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ê°€ì§€ë„ë¡ í–ˆìŠµë‹ˆë‹¤.

	í•´ë‹¹ ë©”ì†Œë“œ ë‚´ì—ì„œëŠ” ì…ë ¥ë°›ì€ methodì™€ url í”„ë¡œí¼í‹°ë¥¼ ì´ìš©í•´ `HTTPRequest` ê°ì²´ë¥¼ ì•„ë˜ì™€ ê°™ì´ ìƒì„±í•©ë‹ˆë‹¤.

	```swift
	//class Request
	func sendRequest(method: String) {
		let rawHTTPRequeat = HTTPRequest(method: method, url: self.url).getRequestMessage()
	    ...
	}
	
	/*struct HTTPRequest {
	    var requestMessage: String
	    var method: String
	    var uri: String = "/home/index.jsp"
	    var httpVersion: String = "HTTP/1.1"
	    var headers: String
	    var body: String = ""
	    
	    init(method: String, url: URL) {
	        self.method = method
	        self.headers = "Host: \(NWEndpoint.Host.init(url.host!))\r\n"
	        self.requestMessage = "\(method) \(uri) \(httpVersion)\r\n\(headers)\r\n\(body)"
	    }
	    
	    func getRequestMessage() -> String { //ì „ì†¡í•˜ê¸° ìœ„í•´ Request Messageë¥¼ ë¬¸ìì—´ë¡œ returní•˜ëŠ” ë©”ì†Œë“œ
	        return requestMessage
	    }
	}*/
	```

	ì´ì œ ë§Œë“¤ì–´ì§„ Request Messageë¥¼ ì´ìš©í•´ TCP ì„¸ì…˜ì— ì „ì†¡í•˜ê¸° ìœ„í•´, NWConnection íƒ€ì…ì¸ connection í”„ë¡œí¼í‹°ì˜ send ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.  send ë©”ì†Œë“œì˜ ë§¤ê°œë³€ìˆ˜ì¸ `completion` ìœ¼ë¡œ .contentProcessed í´ë¡œì €ë¥¼ ì‚¬ìš©í•˜ëŠ”ë°, í•´ë‹¹ í´ë¡œì € ë‚´ì—ì„œ NWConnection íƒ€ì…ì˜ receiveMessage ë©”ì†Œë“œë¥¼ ì´ìš©í•˜ê²Œ ë©ë‹ˆë‹¤. receiveMessage ë©”ì†Œë“œë¡œ ë°›ì•„ì˜¨ Response Messageë¥¼ ì´ìš©í•´ ì§ì ‘ êµ¬í˜„í•œ `HTTPResponse` íƒ€ì…ì„ ìƒì„±í•©ë‹ˆë‹¤. ìƒì„±ëœ HTTPResponse ê°ì²´ë¥¼ ì´ìš©í•´ í”„ë¡œê·¸ë˜ë° ìš”êµ¬ ì‚¬í•­ì— ë§ê²Œ ì¶œë ¥í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤. 

	ìœ„ì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì™„ì„±í•œ `sendRequest(method: String)` ë©”ì„œë“œëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

	```swift
	//class Request
	func sendRequest(method: String) {
	    let rawHTTPRequest = HTTPRequest(method: method, url: self.url).getRequestMessage()
	    print("**************HTTP Request**************")
	    print(rawHTTPRequest)
	    print("****************************************")
	    connection.send(content: rawHTTPRequest.data(using: .ascii), completion: .contentProcessed( { error in
	        print("\nProcessed, error: \(String(describing: error))\n")
	        self.connection.receiveMessage { data, _, completed, error in
	            if let data = data {
	                let HTTPResponse = HTTPResponse(data: data)
	                print("**********HTTP Response header**********")
	                print(HTTPResponse.headers)
	                print("****************************************")
	                print("***********HTTP Response Body***********")
	                print(HTTPResponse.body)
	                print("****************************************")
	            } else {
	                print("Response: nil , completed: \(completed), error: \(String(describing: error))")
	            }
	        }
	    }))
	}
	```

	í•´ë‹¹ ë©”ì„œë“œë¥¼ ì´ìš©í•œ ì¶œë ¥ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

	<img src="https://user-images.githubusercontent.com/92504186/153452862-16e6aa68-e9eb-475b-b630-528600f75a94.jpg" alt="SS 2022-02-11 AM 01 33 24" width="70%;" />

	

3. ìœ„ì—ì„œ ì‘ì„±í•œ sendRequest ë©”ì†Œë“œ ë‚´ì˜ `self.connection.receive` ë¶€ë¶„ì„ ë”°ë¡œ ë¹¼ë‚´ì–´ `receiveResponse()` ë©”ì†Œë“œë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. í•´ë‹¹ ë©”ì†Œë“œëŠ” Response Messageë¥¼ ìˆ˜ì‹ í•œ í›„ 3ì´ˆë¥¼ ê¸°ë‹¤ë¦¬ê³  Socket ì—°ê²°ì„ í•´ì œí•˜ê³  í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤.

	```swift
	func receiveResponse() {
	    self.connection.receiveMessage { data, _, completed, error in
	        if let data = data {
	            let HTTPResponse = HTTPResponse(data: data)
	            print("**********HTTP Response header**********")
	            print(HTTPResponse.headers)
	            print("****************************************")
	            print("***********HTTP Response Body***********")
	            print(HTTPResponse.body)
	            print("****************************************")
	        } else {
	            print("Response: nil , completed: \(completed), error: \(String(describing: error))")
	        }
	        sleep(3)
	        self.connection.cancel()
	        exit(EXIT_SUCCESS)
	    }
	}
	```

	
